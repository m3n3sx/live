const { test, expect } = require('@playwright/test');

// Konfiguracja test√≥w
const WP_ADMIN_URL = 'http://localhost:10013/wp-admin/';
const LOGIN_USERNAME = 'xxx';
const LOGIN_PASSWORD = 'xxx';

// Helper functions
async function loginToWordPress(page) {
    await page.goto(WP_ADMIN_URL);
    
    // Sprawd≈∫ czy ju≈º zalogowany
    const isLoggedIn = await page.locator('#wpadminbar').isVisible().catch(() => false);
    if (isLoggedIn) return;
    
    // Sprawd≈∫ czy formularz logowania jest dostƒôpny
    await page.waitForSelector('#loginform', { timeout: 10000 });
    
    // Logowanie z lepszƒÖ obs≈ÇugƒÖ b≈Çƒôd√≥w
    await page.fill('#user_login', LOGIN_USERNAME);
    await page.fill('#user_pass', LOGIN_PASSWORD);
    
    // Kliknij submit button
    await page.click('#wp-submit');
    
    // Poczekaj na przekierowanie lub za≈Çadowanie
    await page.waitForTimeout(3000);
    
    // Poczekaj na dashboard lub sprawd≈∫ b≈Çƒôdy logowania
    try {
        await page.waitForSelector('#wpadminbar', { timeout: 10000 });
        console.log('‚úÖ Logowanie pomy≈õlne');
    } catch (error) {
        // Sprawd≈∫ czy sƒÖ b≈Çƒôdy logowania
        const loginError = await page.locator('#login_error').isVisible().catch(() => false);
        if (loginError) {
            const errorText = await page.locator('#login_error').textContent();
            throw new Error(`B≈ÇƒÖd logowania: ${errorText}`);
        }
        
        // Sprawd≈∫ obecny URL dla diagnostyki
        const currentUrl = page.url();
        console.log(`üåê URL po logowaniu: ${currentUrl}`);
        
        // Zr√≥b screenshot dla diagnostyki
        await page.screenshot({ path: 'login-error.png', fullPage: true });
        
        throw new Error(`Nie uda≈Ço siƒô zalogowaƒá. Obecny URL: ${currentUrl}`);
    }
}

async function navigateToMASSettings(page) {
    // Upewnij siƒô ≈ºe jeste≈õmy zalogowani
    await page.waitForSelector('#adminmenu', { timeout: 5000 });
    
    // Hover over admin menu to trigger any submenus
    await page.hover('#adminmenu');
    await page.waitForTimeout(500); // Poczekaj na animacje
    
    try {
        // Spr√≥buj g≈Ç√≥wny link najpierw
        const mainLink = page.locator('#adminmenu .menu-top a[href*="mas-v2-settings"]').first();
        const isMainVisible = await mainLink.isVisible();
        
        if (isMainVisible) {
            console.log('üîó Klikam g≈Ç√≥wny link MAS V2...');
            await mainLink.click();
        } else {
            // Fallback na submenu
            console.log('üîó Szukam w submenu...');
            const submenuLink = page.locator('#adminmenu .wp-submenu a[href*="mas-v2-settings"]').first();
            const isSubmenuVisible = await submenuLink.isVisible();
            
            if (isSubmenuVisible) {
                await submenuLink.click();
            } else {
                // Ostatnia pr√≥ba - bezpo≈õrednia nawigacja
                console.log('üîó Nawigacja bezpo≈õrednia do MAS V2...');
                await page.goto('http://localhost:10013/wp-admin/admin.php?page=mas-v2-settings');
            }
        }
        
        // Poczekaj na za≈Çadowanie strony MAS V2
        await page.waitForSelector('.mas-v2-admin-wrapper', { timeout: 15000 });
        console.log('‚úÖ Strona MAS V2 za≈Çadowana');
        
    } catch (error) {
        // Diagnostyka przy b≈Çƒôdzie
        const currentUrl = page.url();
        console.log(`‚ùå B≈ÇƒÖd nawigacji. URL: ${currentUrl}`);
        
        await page.screenshot({ path: 'navigation-error.png', fullPage: true });
        
        throw new Error(`Nie uda≈Ço siƒô przej≈õƒá do ustawie≈Ñ MAS V2: ${error.message}`);
    }
}

async function waitForElementsToLoad(page) {
    await page.waitForTimeout(1000); // Podstawowe czekanie na animacje
    await page.waitForFunction(() => {
        return document.readyState === 'complete';
    });
}

// Test Suite 1: Podstawowe testy logowania i dostƒôpu
test.describe('MAS V2 - Testy podstawowe', () => {
    test('Logowanie do WordPress i dostƒôp do pluginu', async ({ page }) => {
        await loginToWordPress(page);
        
        // Sprawd≈∫ czy WordPress za≈Çadowa≈Ç siƒô poprawnie
        await expect(page.locator('#wpadminbar')).toBeVisible();
        
        // Na ma≈Çych ekranach menu mo≈ºe byƒá ukryte
        const viewport = page.viewportSize();
        if (viewport && viewport.width >= 783) {
            await expect(page.locator('#adminmenu')).toBeVisible();
        } else {
            console.log('‚ÑπÔ∏è Pomijam sprawdzenie menu na ma≈Çym ekranie');
            return; // Zako≈Ñcz test dla ma≈Çych ekran√≥w
        }
        
        // Sprawd≈∫ czy menu MAS V2 jest dostƒôpne (g≈Ç√≥wny link w menu)
        const masMenuItem = page.locator('#adminmenu .menu-top a[href*="mas-v2-settings"]').first();
        await expect(masMenuItem).toBeVisible();
        
        // Sprawd≈∫ czy alternatywnie submenu jest dostƒôpne
        const masSubmenuItem = page.locator('#adminmenu .wp-submenu a[href*="mas-v2-settings"]');
        const isSubmenuVisible = await masSubmenuItem.isVisible().catch(() => false);
        
        if (!await masMenuItem.isVisible() && !isSubmenuVisible) {
            throw new Error('Ani g≈Ç√≥wne menu MAS V2 ani submenu nie sƒÖ dostƒôpne');
        }
        
        console.log('‚úÖ Logowanie i dostƒôp do menu MAS V2 - OK');
    });
    
    test('Weryfikacja ≈ºe menu nie "ucieka" na g≈Ç√≥wnej stronie wp-admin', async ({ page }) => {
        await loginToWordPress(page);
        
        // Sprawd≈∫ viewport size
        const viewport = page.viewportSize();
        if (viewport && viewport.width < 783) {
            console.log('‚ÑπÔ∏è Pomijam test menu positioning na ma≈Çym ekranie');
            return;
        }
        
        const adminMenu = page.locator('#adminmenu');
        await expect(adminMenu).toBeVisible();
        
        // Sprawd≈∫ pozycjonowanie menu
        const menuBox = await adminMenu.boundingBox();
        expect(menuBox.x).toBeGreaterThan(-10); // Menu nie powinno byƒá ukryte po lewej
        expect(menuBox.y).toBeGreaterThan(-10); // Menu nie powinno byƒá ukryte u g√≥ry
        
        // Sprawd≈∫ czy submenu dzia≈Ça
        await page.hover('#adminmenu .menu-top:first-child');
        await page.waitForTimeout(500);
        
        const submenu = page.locator('#adminmenu .wp-submenu').first();
        if (await submenu.isVisible()) {
            const submenuBox = await submenu.boundingBox();
            expect(submenuBox.x).toBeGreaterThan(0);
            expect(submenuBox.y).toBeGreaterThan(0);
        }
        
        console.log('‚úÖ Menu positioning na g≈Ç√≥wnej stronie - OK');
    });
});

// Test Suite 2: Testy interfejsu MAS V2
test.describe('MAS V2 - Testy interfejsu pluginu', () => {
    test.beforeEach(async ({ page }) => {
        await loginToWordPress(page);
        await navigateToMASSettings(page);
    });
    
    test('Sprawdzenie ≈ºe menu nie "ucieka" na stronie ustawie≈Ñ MAS V2', async ({ page }) => {
        // Sprawd≈∫ pozycjonowanie menu WordPress na stronie MAS V2
        const adminMenu = page.locator('#adminmenu');
        await expect(adminMenu).toBeVisible();
        
        const menuBox = await adminMenu.boundingBox();
        expect(menuBox.x).toBeGreaterThan(-10);
        expect(menuBox.y).toBeGreaterThan(25); // Powinno byƒá pod admin bar
        expect(menuBox.x).toBeLessThan(200); // Powinno byƒá w normalnej pozycji
        
        // Sprawd≈∫ czy submenu dzia≈Ça na stronie ustawie≈Ñ
        const menuItem = page.locator('#adminmenu .menu-top').first();
        await menuItem.hover();
        await page.waitForTimeout(500);
        
        const submenu = page.locator('#adminmenu .wp-submenu').first();
        if (await submenu.isVisible()) {
            const submenuBox = await submenu.boundingBox();
            expect(submenuBox.x).toBeGreaterThan(menuBox.x); // Submenu powinno byƒá na prawo od menu
        }
        
        console.log('‚úÖ Menu positioning na stronie MAS V2 - OK');
    });
    
    test('Weryfikacja za≈Çadowania interfejsu MAS V2', async ({ page }) => {
        // Sprawd≈∫ g≈Ç√≥wne elementy interfejsu
        await expect(page.locator('.mas-v2-admin-wrapper')).toBeVisible();
        await expect(page.locator('.mas-v2-header')).toBeVisible();
        await expect(page.locator('.mas-v2-title')).toBeVisible();
        await expect(page.locator('.mas-v2-nav-tabs')).toBeVisible();
        
        // Sprawd≈∫ czy tytu≈Ç jest poprawny
        await expect(page.locator('.mas-v2-title')).toContainText('Modern Admin Styler V2');
        
        // Sprawd≈∫ czy sƒÖ dostƒôpne zak≈Çadki
        const tabs = page.locator('.mas-v2-nav-tab');
        const tabCount = await tabs.count();
        expect(tabCount).toBeGreaterThan(5); // Powinno byƒá co najmniej 6 zak≈Çadek
        
        console.log('‚úÖ Interface MAS V2 za≈Çadowany poprawnie');
    });
    
    test('Test nawigacji miƒôdzy zak≈Çadkami', async ({ page }) => {
        await waitForElementsToLoad(page);
        
        // Lista zak≈Çadek do przetestowania
        const tabs = [
            { selector: 'a[href*="mas-v2-general"]', name: 'General' },
            { selector: 'a[href*="mas-v2-admin-bar"]', name: 'Admin Bar' },
            { selector: 'a[href*="mas-v2-menu"]', name: 'Menu' },
            { selector: 'a[href*="mas-v2-content"]', name: 'Content' },
            { selector: 'a[href*="mas-v2-effects"]', name: 'Effects' }
        ];
        
        for (const tab of tabs) {
            await page.click(tab.selector);
            await waitForElementsToLoad(page);
            
            // Sprawd≈∫ czy URL siƒô zmieni≈Ç
            const currentUrl = page.url();
            expect(currentUrl).toContain('mas-v2');
            
            // Sprawd≈∫ czy strona siƒô za≈Çadowa≈Ça
            await expect(page.locator('.mas-v2-admin-wrapper')).toBeVisible();
            
            // Sprawd≈∫ czy menu nadal jest w dobrej pozycji
            const adminMenu = page.locator('#adminmenu');
            const menuBox = await adminMenu.boundingBox();
            expect(menuBox.x).toBeGreaterThan(-10);
            expect(menuBox.x).toBeLessThan(200);
            
            console.log(`‚úÖ Zak≈Çadka ${tab.name} - OK`);
        }
    });
});

// Test Suite 3: Testy funkcjonalno≈õci opcji
test.describe('MAS V2 - Testy funkcjonalno≈õci', () => {
    test.beforeEach(async ({ page }) => {
        await loginToWordPress(page);
        await navigateToMASSettings(page);
        await page.click('a[href*="mas-v2-menu"]'); // Id≈∫ do zak≈Çadki Menu
        await waitForElementsToLoad(page);
    });
    
    test('Test w≈ÇƒÖczania/wy≈ÇƒÖczania opcji floating menu', async ({ page }) => {
        // Znajd≈∫ toggle dla floating menu
        const floatingToggle = page.locator('input[name="menu_floating"]');
        
        if (await floatingToggle.isVisible()) {
            const initialState = await floatingToggle.isChecked();
            
            // Prze≈ÇƒÖcz opcjƒô
            await floatingToggle.click();
            await page.waitForTimeout(500);
            
            const newState = await floatingToggle.isChecked();
            expect(newState).toBe(!initialState);
            
            console.log('‚úÖ Toggle floating menu - OK');
        }
    });
    
    test('Test zapisywania ustawie≈Ñ', async ({ page }) => {
        // Znajd≈∫ przycisk zapisz
        const saveButton = page.locator('input[type="submit"], button[type="submit"]').first();
        
        if (await saveButton.isVisible()) {
            await saveButton.click();
            
            // Czekaj na komunikat sukcesu lub redirect
            await page.waitForTimeout(2000);
            
            // Sprawd≈∫ czy nie ma b≈Çƒôd√≥w PHP
            const bodyText = await page.textContent('body');
            expect(bodyText).not.toContain('Fatal error');
            expect(bodyText).not.toContain('Parse error');
            expect(bodyText).not.toContain('Warning:');
            
            console.log('‚úÖ Zapisywanie ustawie≈Ñ - OK');
        }
    });
    
    test('Test Live Preview', async ({ page }) => {
        // Sprawd≈∫ czy jest przycisk Live Preview
        const livePreviewToggle = page.locator('.mas-live-preview-toggle');
        
        if (await livePreviewToggle.isVisible()) {
            await livePreviewToggle.click();
            await page.waitForTimeout(1000);
            
            // Sprawd≈∫ czy przycisk siƒô aktywowa≈Ç
            const isActive = await livePreviewToggle.getAttribute('class');
            console.log('Live Preview toggle state:', isActive);
            
            console.log('‚úÖ Live Preview toggle - OK');
        }
    });
});

// Test Suite 4: Testy responsywno≈õci
test.describe('MAS V2 - Testy responsywno≈õci', () => {
    const viewports = [
        { width: 1920, height: 1080, name: 'Desktop Large' },
        { width: 1366, height: 768, name: 'Desktop Medium' },
        { width: 1024, height: 768, name: 'Tablet Landscape' },
        { width: 768, height: 1024, name: 'Tablet Portrait' },
        { width: 480, height: 800, name: 'Mobile Large' },
        { width: 320, height: 568, name: 'Mobile Small' }
    ];
    
    for (const viewport of viewports) {
        test(`Test responsywno≈õci ${viewport.name} (${viewport.width}x${viewport.height})`, async ({ page }) => {
            await page.setViewportSize({ width: viewport.width, height: viewport.height });
            await loginToWordPress(page);
            
            // Sprawd≈∫ podstawowe elementy
            await expect(page.locator('#wpadminbar')).toBeVisible();
            
            // Na ma≈Çych ekranach menu mo≈ºe byƒá ukryte
            if (viewport.width >= 783) {
                await expect(page.locator('#adminmenu')).toBeVisible();
                
                // Sprawd≈∫ pozycjonowanie menu
                const adminMenu = page.locator('#adminmenu');
                const menuBox = await adminMenu.boundingBox();
                expect(menuBox.x).toBeGreaterThan(-10);
            }
            
            // Przejd≈∫ do ustawie≈Ñ MAS V2
            if (viewport.width >= 600) { // Na bardzo ma≈Çych ekranach mo≈ºe byƒá trudno
                await navigateToMASSettings(page);
                await waitForElementsToLoad(page);
                
                // Sprawd≈∫ czy interface MAS V2 siƒô dostosowa≈Ç
                await expect(page.locator('.mas-v2-admin-wrapper')).toBeVisible();
                
                // Na ma≈Çych ekranach sprawd≈∫ czy elementy nie wylatujƒÖ poza ekran
                const wrapper = page.locator('.mas-v2-admin-wrapper');
                const wrapperBox = await wrapper.boundingBox();
                expect(wrapperBox.width).toBeLessThanOrEqual(viewport.width + 50); // Tolerancja 50px
            }
            
            console.log(`‚úÖ Responsywno≈õƒá ${viewport.name} - OK`);
        });
    }
});

// Test Suite 5: Testy wydajno≈õci i b≈Çƒôd√≥w
test.describe('MAS V2 - Testy wydajno≈õci i b≈Çƒôd√≥w', () => {
    test('Sprawdzenie b≈Çƒôd√≥w JavaScript w konsoli', async ({ page }) => {
        const consoleErrors = [];
        
        page.on('console', msg => {
            if (msg.type() === 'error') {
                consoleErrors.push(msg.text());
            }
        });
        
        await loginToWordPress(page);
        await navigateToMASSettings(page);
        
        // Przejd≈∫ przez kilka zak≈Çadek
        const tabs = ['mas-v2-general', 'mas-v2-menu', 'mas-v2-effects'];
        for (const tab of tabs) {
            await page.click(`a[href*="${tab}"]`);
            await waitForElementsToLoad(page);
        }
        
        // Sprawd≈∫ czy nie ma krytycznych b≈Çƒôd√≥w JS
        const criticalErrors = consoleErrors.filter(error => 
            !error.includes('favicon') && 
            !error.includes('net::ERR_') &&
            !error.includes('404')
        );
        
        if (criticalErrors.length > 0) {
            console.warn('‚ö†Ô∏è Znalezione b≈Çƒôdy JavaScript:', criticalErrors);
        } else {
            console.log('‚úÖ Brak krytycznych b≈Çƒôd√≥w JavaScript');
        }
        
        expect(criticalErrors.length).toBeLessThan(3); // Tolerancja dla drobnych b≈Çƒôd√≥w
    });
    
    test('Test czasu ≈Çadowania stron', async ({ page }) => {
        const startTime = Date.now();
        
        await loginToWordPress(page);
        const loginTime = Date.now() - startTime;
        
        const navStartTime = Date.now();
        await navigateToMASSettings(page);
        const navTime = Date.now() - navStartTime;
        
        console.log(`‚è±Ô∏è Czas logowania: ${loginTime}ms`);
        console.log(`‚è±Ô∏è Czas ≈Çadowania MAS V2: ${navTime}ms`);
        
        // Sprawd≈∫ czy czasy sƒÖ rozsƒÖdne
        expect(loginTime).toBeLessThan(10000); // Max 10s na logowanie
        expect(navTime).toBeLessThan(5000); // Max 5s na ≈Çadowanie MAS V2
        
        console.log('‚úÖ Wydajno≈õƒá ≈Çadowania - OK');
    });
    
    test('Test memory leaks podczas nawigacji', async ({ page }) => {
        await loginToWordPress(page);
        await navigateToMASSettings(page);
        
        // Symulacja intensywnej nawigacji
        const tabs = ['mas-v2-general', 'mas-v2-admin-bar', 'mas-v2-menu', 'mas-v2-content', 'mas-v2-effects'];
        
        for (let i = 0; i < 3; i++) { // 3 razy przez wszystkie zak≈Çadki
            for (const tab of tabs) {
                await page.click(`a[href*="${tab}"]`);
                await page.waitForTimeout(200);
            }
        }
        
        // Sprawd≈∫ czy strona nadal reaguje
        await expect(page.locator('.mas-v2-admin-wrapper')).toBeVisible();
        
        console.log('‚úÖ Test memory leaks - OK');
    });
});

// Test Suite 6: Testy edge cases
test.describe('MAS V2 - Testy edge cases', () => {
    test('Test zachowania przy disabled JavaScript', async ({ page }) => {
        await page.addInitScript(() => {
            // Symulacja problem√≥w z JS
            window.addEventListener('error', (e) => {
                console.log('JS Error captured:', e.message);
            });
        });
        
        await loginToWordPress(page);
        await navigateToMASSettings(page);
        
        // Sprawd≈∫ czy podstawowy interface dzia≈Ça bez JS
        await expect(page.locator('.mas-v2-admin-wrapper')).toBeVisible();
        await expect(page.locator('#adminmenu')).toBeVisible();
        
        console.log('‚úÖ Test z problemami JS - OK');
    });
    
    test('Test bardzo d≈Çugich warto≈õci w polach', async ({ page }) => {
        await loginToWordPress(page);
        await navigateToMASSettings(page);
        
        // Znajd≈∫ pole tekstowe
        const textField = page.locator('input[type="text"]').first();
        
        if (await textField.isVisible()) {
            const longValue = 'a'.repeat(1000); // 1000 znak√≥w
            await textField.fill(longValue);
            
            const fieldValue = await textField.inputValue();
            expect(fieldValue.length).toBeGreaterThan(0);
            
            console.log('‚úÖ Test d≈Çugich warto≈õci - OK');
        }
    });
    
    test('Test z wy≈ÇƒÖczonymi stylami CSS', async ({ page }) => {
        // Wy≈ÇƒÖcz czƒô≈õƒá styl√≥w CSS
        await page.addStyleTag({
            content: `
                .mas-v2-admin-wrapper { display: block !important; }
                #adminmenu { position: relative !important; }
            `
        });
        
        await loginToWordPress(page);
        await navigateToMASSettings(page);
        
        // Sprawd≈∫ czy podstawowa funkcjonalno≈õƒá dzia≈Ça
        await expect(page.locator('.mas-v2-admin-wrapper')).toBeVisible();
        await expect(page.locator('#adminmenu')).toBeVisible();
        
        console.log('‚úÖ Test z ograniczonymi stylami - OK');
    });
});

// Test podsumowujƒÖcy
test.describe('MAS V2 - Test kompleksowy', () => {
    test('Kompletny workflow u≈ºytkownika', async ({ page }) => {
        console.log('üöÄ Rozpoczynam kompleksowy test workflow...');
        
        // 1. Logowanie
        await loginToWordPress(page);
        console.log('‚úÖ 1. Logowanie - OK');
        
        // 2. Navigacja do MAS V2
        await navigateToMASSettings(page);
        console.log('‚úÖ 2. Navigacja do MAS V2 - OK');
        
        // 3. Sprawdzenie wszystkich zak≈Çadek
        const tabs = [
            'mas-v2-general', 'mas-v2-admin-bar', 'mas-v2-menu', 
            'mas-v2-content', 'mas-v2-buttons', 'mas-v2-effects'
        ];
        
        for (const tab of tabs) {
            await page.click(`a[href*="${tab}"]`);
            await waitForElementsToLoad(page);
            
            // Sprawd≈∫ menu positioning na ka≈ºdej zak≈Çadce
            const adminMenu = page.locator('#adminmenu');
            const menuBox = await adminMenu.boundingBox();
            expect(menuBox.x).toBeGreaterThan(-10);
            expect(menuBox.x).toBeLessThan(200);
        }
        console.log('‚úÖ 3. Test wszystkich zak≈Çadek - OK');
        
        // 4. Test zapisywania
        await page.click('a[href*="mas-v2-menu"]');
        const saveButton = page.locator('input[type="submit"]').first();
        if (await saveButton.isVisible()) {
            await saveButton.click();
            await page.waitForTimeout(2000);
        }
        console.log('‚úÖ 4. Test zapisywania - OK');
        
        // 5. Sprawdzenie czy nie ma b≈Çƒôd√≥w
        const bodyText = await page.textContent('body');
        expect(bodyText).not.toContain('Fatal error');
        expect(bodyText).not.toContain('Parse error');
        console.log('‚úÖ 5. Brak b≈Çƒôd√≥w PHP - OK');
        
        console.log('üéâ KOMPLEKSOWY TEST ZAKO≈ÉCZONY POMY≈öLNIE!');
    });
}); 